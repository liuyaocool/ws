<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket</title>

	<link rel="manifest" href="manifest.json">
	<style>
		:root {
			--bg-color: #373636;
			--pad: 10px;
		}
		body {
			background-color: var(--bg-color);
			margin: 0;
		}
		body, body * {
			box-sizing: border-box;
			color: white;
		}
		#msgs {
			position: absolute;
			top: 10px;
			left: 10px;
			right: 10px;
			bottom: 166px;
			overflow: auto;
		}
		.msg {
			margin-bottom: 15px;
		}
		.msg pre, .msg > div:nth-child(2) {
			background-color: #80808038;
			border-radius: 10px;
			padding: 5px 10px;
			width: fit-content;
			/* margin-right: 10px; */
			margin: 0;
		}
		.msg video {
			max-height: 600px;
    		max-width: 80%;
		}
		.msg img {
			max-width: 90%;
		}
		/* .ot_msg pre {
			margin-left: 5px;
		} */
		.my_msg {
			display: flex;
  			flex-direction: column;
  			align-items: flex-end;
  			padding-right: 10px;
		}
		.time {
			font-size: 12px;
			color: gray;
		}
		.down {
			background-image: url(down.png);
			width: 30px;
  			height: 30px;
  			display: inline-block;
  			background-size: 100%;
  			background-repeat: no-repeat;
			vertical-align: middle;
		}
		.btn {
			background-color: gray;
			line-height: 19px;
		}
		.send {
			float: right;
		}
		#textInput {
			width: 100%;
			height: 100px;
			resize: none;
			outline: none;
			background-color: transparent;
			border: gray 1px solid;
		}
		#textInput:focus {
			border: lime 1px solid;
		}

		.func {
			background-color: var(--bg-color);
			position: absolute;
  			/* bottom: var(--pad); */
  			bottom: calc(15px + var(--pad));
			left: var(--pad);
			right: var(--pad);
		}
		#fileProgress {
			font-size: 12px;
		}
		#message {
			position: absolute;
			bottom: 0px;
			text-align: center;
			width: 100%;
			font-size: 12px;
		}
		green { color: lime; }
		yellow { color: orange; }
		red { color: #ff6868; }
	</style>
</head>

<body>

<div id="msgs">
	<!-- <div class="msg ot_msg"> -->
		<!-- <div class="time">2023-12-12 22:22:22</div> -->
		<!-- <div>（↑↓←→↖↗↙↘↕）？<a href="https://baidu.com" class="down"></a></div> -->
		<!-- <pre>hello</pre> -->
		<!-- <img src="down.png" alt=""> -->
		<!-- <video src="/home/liuyao/Pictures/video/01.mp4" controls></video> -->
	<!-- </div> -->
</div>
<div class="func">
	<input id="statusBtn" class="btn" type="button" value="???">
	<input class="btn" type="button" value="file" onclick="sendFile()">
	<span id="fileProgress"></span>
	<input class="btn send" type="button" value="发送" onclick="sendInput()">
	<!-- <button id="send" type="button">发送</button> -->
	<textarea id="textInput"></textarea>
</div>
<div id="message"></div>

<script>
	// if(isMobile()) {
	// 	document.body.classList.add('phone');
	// }
	const worker = new Worker('upload_worker.js');
	const FILE_BUFFER = {};

	worker.onmessage = e => {
		switch (e.data.type) {
			case 'open': recvOpen(e.data); return;
			case 'message': recvMessage(e.data); return;
			case 'close': recvClose(e.data); return;
			case 'error': recvError(e.data); return;
			case 'send_text': recvSendText(e.data); return;
			case 'progress': recvProgress(e.data); return; 
		}
		console.log(e);
	}

	function recvOpen(event) {
		updateStatus('open');
		// showMsg('I', '已成功连接到WebSocket服务器', 'system');
	};
	
	function recvMessage(e) {
		if (e.data instanceof ArrayBuffer) {
			const uint8Arr = new Uint8Array(e.data);
			const id = uint8Arr[0] << 8 | uint8Arr[1];
			const idx = uint8Arr[2] << 8 | uint8Arr[3];
			FILE_BUFFER[id].partCount--;
			FILE_BUFFER[id].chunks[idx] = e.data.slice(4);
			if (FILE_BUFFER[id].partCount == 0) {
				const blob = FILE_BUFFER[id].blob = new Blob(FILE_BUFFER[id].chunks, {type:  FILE_BUFFER[id].ftype});
  				const url = FILE_BUFFER[id].url = URL.createObjectURL(blob);
				addFile('ot_msg', FILE_BUFFER[id].name, url, FILE_BUFFER[id].ftype);
			}
		} else if (typeof e.data === 'string') {
			let data = JSON.parse(e.data);
			switch(data.type) {
				case 'input': addMsg('ot_msg', data.value); break;
				case 'file': data.chunks = []; FILE_BUFFER[data.id] = data; break;
				default: showMsg('W', '数据类型未知:' + e.data);
			}
		} else {
			showMsg('W', '未知数据类型:' + typeof e.data);
		}
	};
	
	function recvClose(event) {
		updateStatus('close', `${event.code}${event.reason ? ('-' + event.reason) : ''}`);
		// if (event.wasClean) {
		// 	showMsg('I', `连接已关闭，代码: ${event.code}, 原因: ${event.reason}`, 'system');
		// } else {
		// 	showMsg('E', '连接意外断开', 'system');
		// }
	};
	
	function recvError(error) {
		// updateStatus('error', error);
		showMsg('E', '连接发生错误: ' + error);
	};

	// 断开WebSocket连接
	function disconnect() {
		worker.postMessage({type: 'socket_close' });
	}


	// // 监听窗口关闭事件
	// window.addEventListener('beforeunload', function(event) {
	// 	// 显示确认对话框
	// 	event.preventDefault();
	// 	event.returnValue = '您确定要离开吗？未保存的更改可能会丢失。';
	// 	return event.returnValue;
	// });
		
		// 发送消息
	function sendInput() {
		let msg = textInput.value;
		if (!msg || !msg.trim()) return;
		msg = JSON.stringify({type: 'input', value: msg});
		worker.postMessage({
			type: 'send_text',
			text: msg,
		});
	}
	function recvSendText(e) {
		if (e.success) {
			let msg = JSON.parse(e.msg);
			addMsg('my_msg', msg.value);
		} else {
			showMsg('E', '无法发送消息，连接未就绪', 'system');
		}
	}

	async function sendFile() {
		// (0x34 << 8) | 0x45 
		const file = await fileChooser();
		worker.postMessage({
			type: 'send_file',
			file: file
		});
	}
	function recvProgress(e) {
		fileProgress.innerHTML = 
			`${Math.round(e.loaded/e.total*10000)/100}% <span style="color:gray">${e.name}<span>`;
		// showMsg('W', `上传(${Math.round(e.loaded/e.total*10000)/100}%): ${e.name}`);
	}

	function addFile(clas, name, url, type) {
		if (type.startsWith('image/')) {
			addMsgHtm(clas, `<img src="${url}">`);
		} else if(name.endsWith('.mp4')) {
			addMsgHtm(clas, `<video src="${url}" controls></video>`);
		} else {
			addMsgHtm(clas, `<div>${name}<a href="${url}" download="${name}" class="down"></a></div>`);
		}
	}

	function addMsg(clas, msg) {
		addMsgHtm(clas, `<pre class="">${msg}</pre>`);
	}
	function addMsgHtm(clas, htm) {
		msgs.insertAdjacentHTML('beforeend', 
        	`<div class="msg ${clas}">
				<div class="time">${nowStr(true)}</div>
				${htm}
			</div>`
		);
		msgs.scrollTo({
			top: msgs.scrollHeight,
			behavior: 'smooth'
		});
	}

	function showMsg(type, msg) {
		switch(type) {
			case 'I': message.innerHTML = `<green>${msg}</green>`; break;
			case 'W': message.innerHTML = `<yellow>${msg}</yellow>`; break;
			case 'E': message.innerHTML = `<red>${msg}</red>`; break;
		}
	}

	function updateStatus(status, text) {
		let statusMap = {
			open: ['green', '已连接'],
			error: ['#690000', '出错了'],
			close: ['#9e6601', '已关闭'],
		};
		if (!statusMap[status]) return;
		statusBtn.style.backgroundColor = statusMap[status][0];
		statusBtn.value = statusMap[status][1] + (text ? `: ${text}` : '');
	}

	function nowStr(hasTime) {
		let now = new Date();
		let a = now.getMonth() + 1;
		let m = a < 10 ? ('0' + a) : a;
		let d = (a = now.getDate()) < 10 ? ('0' + a) : a;
		let h = (a = now.getHours()) < 10 ? ('0' + a) : a;
		let mi = (a = now.getMinutes()) < 10 ? ('0' + a) : a;
		let s = (a = now.getSeconds()) < 10 ? ('0' + a) : a;
		return `${now.getFullYear()}-${m}-${d}${hasTime ? ` ${h}:${mi}:${s}` : ''}`;
	}

	function isMobile() {
		return /Mobi/.test(navigator.userAgent);
	}

	function fileChooser(accept = null, multiple = false) {
		return new Promise((resolve, reject) => {
			let fileInput = document.createElement('input');
			if (multiple === true) {
				fileInput.multiple = true;
			}
			fileInput.type = 'file';
			if (accept) {
				fileInput.accept = accept;
			}
			fileInput.onchange = function (ev) {
				resolve(multiple === true ? ev.target.files : ev.target.files[0]);
			}
			fileInput.click();
		})
	}
</script>
</body>
</html>
